---
description: RFC 4760 - BGP-4多协议扩展，由T. Bates等人于2007年1月发布，定义了BGP-4的扩展以支持多种网络层协议（如IPv6、IPX、L3VPN等）的路由信息传输，通过MP_REACH_NLRI和MP_UNREACH_NLRI两个新属性实现向后兼容
keywords:
  - RFC4760
  - BGP-4
  - 边界网关协议
  - 多协议扩展
  - MP-BGP
  - MP_REACH_NLRI
  - MP_UNREACH_NLRI
  - IPv6路由
  - AFI
  - SAFI
  - 地址族标识符
  - 后续地址族标识符
  - 网络层可达性信息
  - NLRI
  - 下一跳
  - BGP扩展
properties:
  rfc_number: 4760
  title: "Multiprotocol Extensions for BGP-4"
  authors:
    - name: "T. Bates"
      organization: "Cisco Systems"
    - name: "R. Chandra"
      organization: "Sonoa Systems"
    - name: "D. Katz"
      organization: "Juniper Networks"
    - name: "Y. Rekhter"
      organization: "Juniper Networks"
  publication_date: "2007-01"
  status: "标准跟踪协议"
  category: "BGP扩展"
  obsoletes:
    - "RFC 2858"
---
# RFC 4760 - BGP-4多协议扩展

## 文档概述

RFC 4760是由Cisco Systems的T. Bates、Sonoa Systems的R. Chandra以及Juniper Networks的D. Katz和Y. Rekhter于2007年1月发布的BGP-4扩展标准文档，标题为"Multiprotocol Extensions for BGP-4"（BGP-4多协议扩展）。

该文档定义了BGP-4的扩展，使其能够承载多种网络层协议（如IPv6、IPX、L3VPN等）的路由信息。这些扩展是向后兼容的——支持扩展的路由器可以与不支持扩展的路由器互操作。

RFC 4760废弃了RFC 2858，是BGP多协议扩展的当前标准规范。文档通过引入两个新的可选非传递属性MP_REACH_NLRI和MP_UNREACH_NLRI，实现了对多种网络层协议的支持。

## 历史背景

### BGP-4的IPv4局限性

原始的BGP-4协议设计时主要针对IPv4网络，其中只有三个部分是IPv4特定的：
1. **NEXT_HOP属性** - 表示为IPv4地址
2. **AGGREGATOR属性** - 包含IPv4地址
3. **NLRI（网络层可达性信息）** - 表示为IPv4地址前缀

### 多协议支持的需求

随着互联网的发展，出现了多种新的网络层协议需求：
- **IPv6** - 下一代互联网协议
- **IPX** - Novell网络协议
- **L3VPN** - 第三层虚拟专用网络
- **组播路由** - 需要与单播路由分离的路由信息

### RFC演进历史

- **RFC 2283** - 最早的多协议扩展提案
- **RFC 2858** (1999年) - 第一个标准化的多协议扩展
- **RFC 4760** (2007年) - 当前标准，废弃RFC 2858

## 1. 引言

### BGP-4的IPv4依赖

BGP-4携带的信息中只有三个部分是IPv4特定的：
- NEXT_HOP属性（表示为IPv4地址）
- AGGREGATOR（包含IPv4地址）
- NLRI（表示为IPv4地址前缀）

文档假设任何BGP发言者（包括支持本文档定义的多协议能力的发言者）都必须有IPv4地址（将用于AGGREGATOR属性等）。

### 扩展的核心需求

要使BGP-4支持多种网络层协议的路由，只需要添加两个功能：
1. 将特定网络层协议与下一跳信息关联的能力
2. 将特定网络层协议与NLRI关联的能力

为了识别与下一跳信息和NLRI语义相关的各个网络层协议，本文档使用地址族（Address Family，定义于IANA-AF）和后续地址族（Subsequent Address Family）的组合。

### 设计理念

下一跳信息（由NEXT_HOP属性提供）只有在与可达目的地的通告结合时才有意义（且必要）——在与不可达目的地的通告（撤销路由）结合时，下一跳信息是无意义的。这表明：
- 可达目的地的通告应与这些目的地使用的下一跳分组
- 可达目的地的通告应与不可达目的地的通告分离

### 向后兼容性

为了提供向后兼容性，以及简化多协议能力引入BGP-4的过程，本文档使用两个新属性：
- **MP_REACH_NLRI（多协议可达NLRI）** - 携带可达目的地集合及其下一跳信息
- **MP_UNREACH_NLRI（多协议不可达NLRI）** - 携带不可达目的地集合

这两个属性都是可选且非传递的。这样，不支持多协议能力的BGP发言者将忽略这些属性中携带的信息，并且不会将其传递给其他BGP发言者。

## 2. 需求规范

本文档中的关键词"MUST"、"MUST NOT"、"REQUIRED"、"SHALL"、"SHALL NOT"、"SHOULD"、"SHOULD NOT"、"RECOMMENDED"、"MAY"和"OPTIONAL"应按照RFC 2119中的描述进行解释。

## 3. 多协议可达NLRI - MP_REACH_NLRI（类型代码14）

### 概述

这是一个可选的非传递属性，可用于以下目的：

1. 向对等体通告可行路由
2. 允许路由器通告应用作到达MP_NLRI属性的网络层可达性信息字段中列出的目的地的下一跳的路由器的网络层地址

### 属性编码

```
+---------------------------------------------------------+
| Address Family Identifier (2 octets)                    |
+---------------------------------------------------------+
| Subsequent Address Family Identifier (1 octet)          |
+---------------------------------------------------------+
| Length of Next Hop Network Address (1 octet)            |
+---------------------------------------------------------+
| Network Address of Next Hop (variable)                  |
+---------------------------------------------------------+
| Reserved (1 octet)                                      |
+---------------------------------------------------------+
| Network Layer Reachability Information (variable)       |
+---------------------------------------------------------+
```

### 字段说明

#### 地址族标识符（AFI - Address Family Identifier）

该字段与后续地址族标识符字段组合，用于标识：
- 下一跳字段中携带的地址必须属于的网络层协议集
- 下一跳地址的编码方式
- 后续网络层可达性信息的语义

如果允许下一跳来自多个网络层协议，则下一跳的编码**必须**提供确定其网络层协议的方法。

当前定义的地址族标识符字段值在IANA的地址族编号注册表[IANA-AF]中指定。

#### 后续地址族标识符（SAFI - Subsequent Address Family Identifier）

该字段与地址族标识符字段组合，用于标识：
- 下一跳中携带的地址必须属于的网络层协议集
- 下一跳地址的编码方式
- 后续网络层可达性信息的语义

如果允许下一跳来自多个网络层协议，则下一跳的编码**必须**提供确定其网络层协议的方法。

#### 下一跳网络地址长度（Length of Next Hop Network Address）

1字节字段，其值表示"下一跳网络地址"字段的长度，以字节为单位。

#### 下一跳网络地址（Network Address of Next Hop）

可变长度字段，包含到达目标系统的路径上下一个路由器的网络地址。与下一跳网络地址关联的网络层协议由属性中携带的<AFI, SAFI>组合标识。

#### 保留字段（Reserved）

1字节字段，**必须**设置为0，接收时**应该**被忽略。

#### 网络层可达性信息（NLRI - Network Layer Reachability Information）

可变长度字段，列出此属性中通告的可行路由的NLRI。NLRI的语义由属性中携带的<AFI, SAFI>组合标识。

当后续地址族标识符字段设置为本文档中定义的值之一时，每个NLRI按照本文档"NLRI编码"部分的规定进行编码。

### 使用规则

MP_REACH_NLRI路径属性中携带的下一跳信息定义了**应该**用作到达UPDATE消息中MP_NLRI属性列出的目的地的下一跳的路由器的网络层地址。

下一跳信息的规则与BGP NEXT_HOP属性中携带的信息规则相同（参见BGP-4的5.1.3节）。

携带MP_REACH_NLRI的UPDATE消息**必须**同时携带ORIGIN和AS_PATH属性（在EBGP和IBGP交换中都是如此）。此外，在IBGP交换中，此类消息**必须**还携带LOCAL_PREF属性。

### 重要约束

除了MP_REACH_NLRI属性中编码的NLRI之外，不携带其他NLRI的UPDATE消息**不应该**携带NEXT_HOP属性。如果此类消息包含NEXT_HOP属性，接收该消息的BGP发言者**应该**忽略此属性。

UPDATE消息**不应该**在以下字段中多次包含相同的地址前缀（相同的<AFI, SAFI>）：
- WITHDRAWN ROUTES字段
- Network Reachability Information字段
- MP_REACH_NLRI字段
- MP_UNREACH_NLRI字段

以这种形式处理UPDATE消息是未定义的。

## 4. 多协议不可达NLRI - MP_UNREACH_NLRI（类型代码15）

### 概述

这是一个可选的非传递属性，可用于从服务中撤销多个不可行路由。

### 属性编码

```
+---------------------------------------------------------+
| Address Family Identifier (2 octets)                    |
+---------------------------------------------------------+
| Subsequent Address Family Identifier (1 octet)          |
+---------------------------------------------------------+
| Withdrawn Routes (variable)                             |
+---------------------------------------------------------+
```

### 字段说明

#### 地址族标识符（AFI）

该字段与后续地址族标识符字段组合，用于标识被撤销路由的网络层协议集和NLRI的语义。

当前定义的地址族标识符字段值在IANA的地址族编号注册表[IANA-AF]中指定。

#### 后续地址族标识符（SAFI）

该字段与地址族标识符字段组合，用于标识被撤销路由的网络层协议集和NLRI的语义。

#### 撤销路由网络层可达性信息（Withdrawn Routes NLRI）

可变长度字段，列出正在从服务中撤销的路由的NLRI。NLRI的语义由属性中携带的<AFI, SAFI>组合标识。

当后续地址族标识符字段设置为本文档中定义的值之一时，每个NLRI按照本文档"NLRI编码"部分的规定进行编码。

### 使用规则

包含MP_UNREACH_NLRI的UPDATE消息不需要携带任何其他路径属性。

## 5. NLRI编码

网络层可达性信息编码为一个或多个<length, prefix>形式的二元组，其字段描述如下：

```
+---------------------------+
|   Length (1 octet)        |
+---------------------------+
|   Prefix (variable)       |
+---------------------------+
```

### 字段说明

#### 长度（Length）

长度字段指示地址前缀的长度（以位为单位）。长度为零表示匹配所有（由地址族指定的）地址的前缀（前缀本身为零字节）。

#### 前缀（Prefix）

前缀字段包含地址前缀，后跟足够的尾随位以使字段的末尾落在字节边界上。注意，尾随位的值是无关紧要的。

## 6. 后续地址族标识符

本文档为MP_REACH_NLRI和MP_UNREACH_NLRI属性中携带的后续地址族标识符字段定义了以下值：

- **1** - 用于单播转发的网络层可达性信息
- **2** - 用于组播转发的网络层可达性信息

实现**可以**支持本文档中定义的所有、部分或不支持任何后续地址族标识符值。

## 7. 错误处理

如果BGP发言者从邻居接收到包含MP_REACH_NLRI或MP_UNREACH_NLRI属性的UPDATE消息，并且发言者确定该属性不正确，则发言者**必须**删除从该邻居接收的所有BGP路由，这些路由的AFI/SAFI与不正确的MP_REACH_NLRI或MP_UNREACH_NLRI属性中携带的AFI/SAFI相同。

在接收UPDATE消息的BGP会话期间，发言者**应该**忽略通过该会话接收的具有该AFI/SAFI的所有后续路由。

此外，发言者**可以**终止接收UPDATE消息的BGP会话。会话**应该**使用指示"UPDATE Message Error"/"Optional Attribute Error"的通知消息代码/子代码终止。

## 8. BGP能力通告的使用

使用多协议扩展的BGP发言者**应该**使用能力通告过程[BGP-CAP]来确定发言者是否可以与特定对等体使用多协议扩展。

能力可选参数中的字段设置如下：
- 能力代码字段设置为1（表示多协议扩展能力）
- 能力长度字段设置为4
- 能力值字段定义如下：

```
                 0       7      15      23      31
                 +-------+-------+-------+-------+
                 |      AFI      | Res.  | SAFI  |
                 +-------+-------+-------+-------+
```

### 字段说明

**AFI（地址族标识符）** - 16位，编码方式与多协议扩展中相同

**Res.（保留）** - 8位字段，**应该**由发送方设置为0，接收方忽略

注意：不将字段值设置为0可能会为不忽略该字段的接收方造成问题。此外，如果尝试重新定义该字段，此定义会有问题。

**SAFI（后续地址族标识符）** - 8位，编码方式与多协议扩展中相同

### 使用规则

支持多个<AFI, SAFI>元组的发言者将它们作为能力可选参数中的多个能力包含。

要在一对BGP发言者之间进行特定<AFI, SAFI>的双向路由信息交换，每个发言者**必须**向另一个发言者通告（通过能力通告机制）支持该特定<AFI, SAFI>路由的能力。

## 9. IANA考虑

如本文档所述，MP_REACH_NLRI和MP_UNREACH_NLRI属性包含后续地址族标识符（SAFI）字段。SAFI命名空间在本文档中定义。IANA按如下方式注册和维护SAFI命名空间的值：

- **SAFI值1和2** - 在本文档中分配
- **SAFI值3** - 保留。RFC 2858为从未完全实现的用途分配了该值，因此本文档将其废弃
- **SAFI值5到63** - 由IANA使用RFC 2434中定义的标准行动过程或RFC 4020中定义的早期IANA分配过程分配
- **SAFI值67到127** - 由IANA使用RFC 2434中定义的"先到先得"策略分配
- **SAFI值0和255** - 保留
- **SAFI值128到240** - 是先前"私有使用"范围的一部分。在本文档批准时，路由区域主管向IANA提供了未使用的值。这些未使用的值（即130、131、135到139和141到240）被视为保留，以避免冲突
- **SAFI值241到254** - 用于"私有使用"，此范围内的值不由IANA分配

## 10. 与RFC 2858的比较

本文档使下一跳信息的使用与BGP NEXT_HOP路径属性中携带的信息保持一致。

本文档删除了SAFI 3的定义并废弃SAFI 3。

本文档更改了SAFI空间的划分。具体来说，在RFC 2858中，SAFI值128到240是"私有使用"范围的一部分。本文档规定，在此范围内，当前正在使用的分配应由IANA识别，未使用的值（即130、131、135到139和141到240）应被视为保留。

本文档将"Number of SNPAs"字段重命名为"Reserved"，并从MP_REACH_NLRI属性中删除了其余的SNPA相关信息。

## 11. 与RFC 2283的比较

本文档限制MP_REACH_NLRI属性只能携带单个<AFI, SAFI, Next Hop Information, ...>实例。

本文档限制MP_UNREACH_NLRI属性只能携带单个<AFI, SAFI, ...>实例。

本文档澄清了对不携带NLRI（除了MP_REACH_NLRI属性中编码的NLRI之外）的UPDATE消息的处理。

本文档澄清了在存在MP_REACH_NLRI或MP_UNREACH_NLRI属性时的错误处理。

本文档规定了BGP能力通告与多协议扩展结合使用。

最后，本文档包含了"IANA考虑"部分。

## 12. 安全考虑

BGP的这一扩展不会改变现有BGP中固有的底层安全问题。

## 技术影响与意义

### BGP多协议支持的重要性

RFC 4760为BGP提供了支持多种网络层协议的能力，这对互联网的发展具有深远影响：

1. **IPv6部署** - 使BGP能够承载IPv6路由信息，为IPv6网络的部署提供了关键支持
2. **VPN服务** - 支持L3VPN等虚拟专用网络服务的路由分发
3. **组播路由** - 将单播和组播路由信息分离，提高路由效率
4. **协议灵活性** - 为未来新网络层协议的支持提供了框架

### 设计优势

RFC 4760的设计体现了几个重要优势：

1. **向后兼容** - 通过使用可选非传递属性，确保与不支持多协议扩展的BGP路由器兼容
2. **模块化设计** - 使用<AFI, SAFI>组合标识不同的网络层协议，提供了清晰的扩展机制
3. **信息分离** - 将可达和不可达路由信息分离，提高了协议效率
4. **能力协商** - 通过BGP能力通告机制，使对等体能够协商支持的协议

### 实际应用

MP-BGP（多协议BGP）已成为现代互联网基础设施的核心组件：

- **IPv6互联网** - 全球IPv6路由表通过MP-BGP分发
- **MPLS VPN** - 企业VPN服务依赖MP-BGP传递VPN路由
- **数据中心网络** - EVPN等新技术基于MP-BGP构建
- **服务提供商网络** - 运营商使用MP-BGP支持多种服务

## 属性类型代码汇总

| 属性名称 | 类型代码 | 属性类型 | 用途 |
|---------|---------|---------|------|
| MP_REACH_NLRI | 14 | 可选非传递 | 通告可达路由及下一跳信息 |
| MP_UNREACH_NLRI | 15 | 可选非传递 | 撤销不可达路由 |

## SAFI值定义

| SAFI值 | 用途 |
|--------|------|
| 1 | 单播转发的网络层可达性信息 |
| 2 | 组播转发的网络层可达性信息 |
| 3 | 保留（已废弃） |

## 参考文献

### 规范性参考文献

- **[BGP-CAP]** - Chandra, R. and J. Scudder, "Capabilities Advertisement with BGP-4", RFC 3392, November 2002
- **[BGP-4]** - Rekhter, Y., Li, T., and S. Hares, "A Border Gateway Protocol 4 (BGP-4)", RFC 4271, January 2006
- **[IANA-AF]** - "Address Family Numbers", 可从 http://www.iana.org/numbers.html 获取
- **[RFC2119]** - Bradner, S., "Key words for use in RFCs to Indicate Requirement Levels", BCP 14, RFC 2119, March 1997
- **[RFC2434]** - Narten, T. and H. Alvestrand, "Guidelines for Writing an IANA Considerations Section in RFCs", BCP 26, RFC 2434, October 1998
- **[RFC4020]** - Kompella, K. and A. Zinin, "Early IANA Allocation of Standards Track Code Points", BCP 100, RFC 4020, February 2005

## 作者信息

### Tony Bates
- **组织**: Cisco Systems, Inc.
- **邮箱**: tbates@cisco.com

### Ravi Chandra
- **组织**: Sonoa Systems
- **邮箱**: rchandra@sonoasystems.com

### Dave Katz
- **组织**: Juniper Networks, Inc.
- **邮箱**: dkatz@juniper.net

### Yakov Rekhter
- **组织**: Juniper Networks, Inc.
- **邮箱**: yakov@juniper.net

## 总结

RFC 4760是BGP协议发展史上的里程碑文档，它通过定义多协议扩展使BGP能够支持IPv4之外的多种网络层协议。该文档废弃了RFC 2858，成为BGP多协议扩展的当前标准。

通过引入MP_REACH_NLRI和MP_UNREACH_NLRI两个新的可选非传递属性，RFC 4760实现了向后兼容的多协议支持。这些扩展使用<AFI, SAFI>组合来标识不同的网络层协议和路由用途，为IPv6、VPN、组播等多种应用提供了统一的路由分发机制。

文档的主要贡献包括：

1. **定义了两个新的BGP路径属性**：MP_REACH_NLRI（类型代码14）用于通告可达路由，MP_UNREACH_NLRI（类型代码15）用于撤销路由
2. **建立了SAFI命名空间**：定义了后续地址族标识符的分配规则和初始值
3. **规范了能力协商机制**：明确了如何使用BGP能力通告来协商多协议支持
4. **改进了错误处理**：提供了清晰的错误处理指导
5. **澄清了与早期版本的差异**：详细说明了与RFC 2858和RFC 2283的区别

RFC 4760的设计体现了向后兼容、模块化和可扩展性的原则。通过使用可选非传递属性，确保了不支持多协议扩展的BGP路由器可以继续正常工作。通过<AFI, SAFI>组合的设计，为未来新协议的支持提供了清晰的扩展路径。

今天，MP-BGP已成为现代互联网基础设施不可或缺的组成部分，支撑着IPv6互联网、MPLS VPN、数据中心网络等关键应用。RFC 4760为BGP协议的持续演进和互联网的多样化发展奠定了坚实基础。

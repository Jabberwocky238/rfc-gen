---
description: RFC 1186 - MD4消息摘要算法，由MIT计算机科学实验室的Ronald L. Rivest于1990年10月发布，定义了一种快速的128位哈希函数，用于为任意长度的消息生成数字指纹，广泛应用于数字签名和数据完整性验证
keywords:
  - RFC1186
  - MD4
  - Message Digest
  - 消息摘要
  - 哈希算法
  - Hash Algorithm
  - 密码学
  - Cryptography
  - 数字签名
  - Digital Signature
  - RSA
  - 数据完整性
  - Data Integrity
  - 单向函数
  - One-way Function
  - 碰撞抗性
  - Collision Resistance
  - Ronald Rivest
  - MIT
  - 128位哈希
properties:
  rfc_number: 1186
  title: "The MD4 Message Digest Algorithm"
  authors:
    - name: "Ronald L. Rivest"
      organization: "MIT Laboratory for Computer Science"
  publication_date: "1990-10"
  status: "信息性备忘录（已被RFC 1320更新，不推荐使用）"
  category: "密码学算法"
  obsoleted_by: "RFC 1320, RFC 1321 (MD5)"
  related_rfc:
    - "RFC 1320"
    - "RFC 1321"
    - "RFC 2104"
---
# RFC 1186 - MD4消息摘要算法

## 文档概述

RFC 1186是由麻省理工学院（MIT）计算机科学实验室的Ronald L. Rivest于1990年10月发布的信息性备忘录，标题为"The MD4 Message Digest Algorithm"（MD4消息摘要算法）。该文档详细描述了MD4算法的设计、实现和应用。

MD4是一种密码学哈希函数，能够接受任意长度的输入消息，并生成一个128位（16字节）的"数字指纹"或"消息摘要"。该算法的设计目标是在保证安全性的同时，提供极高的运算速度，特别是在32位计算机上。MD4算法被设计用于数字签名应用，在使用RSA公钥密码系统签名之前，需要以安全的方式"压缩"大文件。

**性能特点**：
- 在SUN Sparc工作站上：1,450,000 字节/秒
- 在DEC MicroVax II上：约70,000 字节/秒
- 在20MHz 80286上：约32,000 字节/秒

MD4算法不需要大型替换表，可以非常紧凑地编码实现。该算法被置于公共领域供审查，并可能被采纳为标准。

## 历史背景

### 密码学哈希函数的需求

在1980年代末期，随着数字签名技术的发展，密码学界迫切需要一种高效的哈希函数。数字签名的一个关键问题是：直接对大文件进行签名计算量太大，特别是使用RSA等公钥算法时。因此需要一种方法将任意大小的消息"压缩"成固定长度的摘要，然后对摘要进行签名。

### Ronald Rivest的贡献

Ronald L. Rivest是RSA算法的三位发明者之一（R代表Rivest），也是密码学领域的先驱。在开发MD4之前，他已经在密码学领域做出了重要贡献。MD4是他设计的消息摘要算法系列的第四个版本（MD代表Message Digest）。

### 设计目标

MD4的设计有以下几个主要目标：

1. **安全性**：计算上不可行找到两个产生相同摘要的不同消息（抗碰撞性）
2. **单向性**：给定摘要值，计算上不可行找到产生该摘要的消息（抗原像攻击）
3. **高速度**：特别是在32位机器上要有极高的处理速度
4. **简洁性**：算法实现简单，不需要大型查找表
5. **可移植性**：易于在不同平台上实现

### MD4的历史地位

MD4是消息摘要算法发展史上的重要里程碑。它不仅在当时提供了出色的性能，还为后续的哈希算法（如MD5、SHA-1等）奠定了设计基础。许多现代哈希函数都借鉴了MD4的设计思想。

## 术语和符号

### 基本术语

- **字（Word）**：32位数量
- **字节（Byte）**：8位数量
- **消息（Message）**：任意长度的位序列
- **消息摘要（Message Digest）**：128位的输出值

### 数据表示

**位序列到字节序列**：
- 位序列可以自然地解释为字节序列
- 每连续8位组成一个字节
- 每个字节的高位（最高有效位）在前

**字节序列到字序列**：
- 字节序列可以解释为32位字序列
- 每连续4个字节组成一个字
- 低位（最低有效）字节在前（小端序）

### 数学符号

- **x_i**：表示"x下标i"
- **x^i**：表示"x的i次方"
- **+**：表示字的加法（即模2^32加法）
- **X <<< s**：表示X循环左移s位
- **not(X)**：X的按位补码
- **X v Y**：X和Y的按位或（OR）
- **X xor Y**：X和Y的按位异或（XOR）
- **XY**：X和Y的按位与（AND）

## MD4算法描述

MD4算法将任意长度的消息作为输入，通过五个步骤计算出128位的消息摘要。

### 步骤1：填充位（Append Padding Bits）

**目的**：将消息扩展到长度对512取模等于448位。

**过程**：
1. 消息被"填充"（扩展），使其长度（以位为单位）对512取模等于448
2. 即消息被扩展到距离512位的倍数还差64位
3. 填充总是执行，即使消息长度已经满足条件（此时添加512位填充）

**填充方法**：
1. 首先追加一个"1"位
2. 然后追加足够的"0"位，直到长度对512取模等于448

**示例**：
- 原始消息长度为0位：填充448位（1个"1"加447个"0"）
- 原始消息长度为448位：填充512位（1个"1"加511个"0"）

### 步骤2：追加长度（Append Length）

**目的**：将原始消息的长度信息追加到填充后的消息末尾。

**过程**：
1. 将b（填充前消息的长度，以位为单位）的64位表示追加到步骤1的结果后面
2. 如果b大于2^64（不太可能），则只使用b的低64位
3. 这些位以两个32位字的形式追加，低位字在前

**结果**：
- 此时消息长度恰好是512位的倍数
- 等价地，消息长度是16个32位字的倍数
- 设M[0...N-1]表示结果消息的字，其中N是16的倍数

### 步骤3：初始化MD缓冲区（Initialize MD Buffer）

**目的**：初始化用于计算消息摘要的4字缓冲区。

**缓冲区结构**：
- 使用4字缓冲区(A, B, C, D)来计算消息摘要
- 每个A、B、C、D都是32位寄存器

**初始值**（十六进制，低位字节在前）：
```
word A: 01 23 45 67
word B: 89 ab cd ef
word C: fe dc ba 98
word D: 76 54 32 10
```

这些初始值是精心选择的常量，用于确保算法的安全性。

### 步骤4：以16字块处理消息（Process Message in 16-word Blocks）

这是MD4算法的核心部分，包含三轮处理。

#### 辅助函数

首先定义三个辅助函数，每个函数接受三个32位字作为输入，产生一个32位字作为输出：

```
f(X,Y,Z) = XY v not(X)Z
g(X,Y,Z) = XY v XZ v YZ
h(X,Y,Z) = X xor Y xor Z
```

**函数特性**：

1. **函数f**：在每个位位置上作为条件函数：if X then Y else Z
   - 可以理解为：如果X的某位为1，则输出Y的该位；否则输出Z的该位
   - 由于XY和not(X)Z不会在同一位位置都为1，可以用+代替v

2. **函数g**：在每个位位置上作为多数函数
   - 如果X、Y、Z中至少两个在某位为1，则g在该位为1
   - 否则g在该位为0

3. **函数h**：按位异或或"奇偶"函数
   - 具有与f和g类似的统计特性

#### 三轮处理

对每个16字块执行以下操作：

**第1轮（Round 1）**：
- 使用函数f
- 操作定义：[A B C D i s] 表示 A = (A + f(B,C,D) + X[i]) <<< s
- 执行16次操作，移位量为3, 7, 11, 19循环使用
- 按顺序处理X[0]到X[15]

**第2轮（Round 2）**：
- 使用函数g
- 操作定义：[A B C D i s] 表示 A = (A + g(B,C,D) + X[i] + 5A827999) <<< s
- 常量5A827999（十六进制）= sqrt(2)的小数部分
- 执行16次操作，移位量为3, 5, 9, 13循环使用
- 按特定顺序处理：0,4,8,12,1,5,9,13,2,6,10,14,3,7,11,15

**第3轮（Round 3）**：
- 使用函数h
- 操作定义：[A B C D i s] 表示 A = (A + h(B,C,D) + X[i] + 6ED9EBA1) <<< s
- 常量6ED9EBA1（十六进制）= sqrt(3)的小数部分
- 执行16次操作，移位量为3, 9, 11, 15循环使用
- 按特定顺序处理：0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15

**每个块处理后**：
```
A = A + AA
B = B + BB
C = C + CC
D = D + DD
```
其中AA、BB、CC、DD是处理该块前保存的A、B、C、D的值。

### 步骤5：输出（Output）

**输出格式**：
- 消息摘要的输出为A、B、C、D
- 从A的低位字节开始，到D的高位字节结束
- 总共128位（16字节）

**输出顺序**：
```
A的字节0, A的字节1, A的字节2, A的字节3,
B的字节0, B的字节1, B的字节2, B的字节3,
C的字节0, C的字节1, C的字节2, C的字节3,
D的字节0, D的字节1, D的字节2, D的字节3
```

## 扩展功能

### 256位输出扩展

如果需要超过128位的输出，RFC 1186提供了获得256位输出的方法（不支持超过256位）。

**方法**：
1. 并行运行两个MD4副本处理输入
2. 第一个副本使用标准配置
3. 第二个副本使用修改后的配置

**第二个副本的修改**：

**初始状态**：
```
word A: 00 11 22 33
word B: 44 55 66 77
word C: 88 99 aa bb
word D: cc dd ee ff
```

**魔术常量**：
- 第2轮常量：从sqrt(2)改为cuberoot(2) = 50a28be6（十六进制）
- 第3轮常量：从sqrt(3)改为cuberoot(3) = 5c4dd124（十六进制）

**A寄存器交换**：
- 每处理完一个16字块后（包括最后一个块）
- 交换两个副本中A寄存器的值

**最终输出**：
- 将第二个副本的结果追加到第一个副本的结果后面
- 得到256位（32字节）的消息摘要

## 安全性分析

### 设计安全性

RFC 1186对MD4的安全性做出了以下推测：

1. **抗碰撞性**：找到两个产生相同消息摘要的不同消息的难度约为2^64次操作
2. **抗原像攻击**：给定消息摘要，找到产生该摘要的消息的难度约为2^128次操作

### 安全性假设

MD4的安全性基于以下假设：

1. **雪崩效应**：输入的微小变化应导致输出的显著变化
2. **不可逆性**：从输出无法推导出输入
3. **均匀分布**：输出应在整个128位空间中均匀分布

### 已知安全问题

**重要提示**：现代密码学分析已经发现MD4存在严重的安全漏洞：

1. **碰撞攻击**：1996年，Hans Dobbertin发现了MD4的碰撞攻击方法
2. **实用性攻击**：现代计算机可以在几秒钟内找到MD4碰撞
3. **不推荐使用**：MD4已被认为在密码学上不安全，不应用于安全关键应用

**历史意义**：尽管MD4本身已不安全，但它为后续算法（MD5、SHA系列）的设计提供了重要基础。

## 应用场景

### 数字签名

MD4最初设计的主要应用场景：

1. **与RSA结合**：先用MD4计算消息摘要，再用RSA签名摘要
2. **效率提升**：避免直接对大文件进行RSA运算
3. **固定长度**：无论消息多大，摘要都是128位

### 数据完整性验证

MD4可用于验证数据是否被篡改：

1. **文件校验**：计算文件的MD4摘要作为指纹
2. **传输验证**：比较传输前后的摘要值
3. **存储验证**：定期检查存储数据的完整性

### 密码存储

在MD4发现漏洞之前的应用：

1. **密码哈希**：存储密码的MD4摘要而非明文
2. **单向性**：理论上无法从摘要恢复密码
3. **现代替代**：现在应使用bcrypt、scrypt或Argon2等专用算法

## 实现考虑

### 字节序问题

MD4实现需要注意字节序（Endianness）：

1. **小端序系统**（如VAX、x86）：
   - 最低有效字节存储在最低地址
   - 可以直接处理数据

2. **大端序系统**（如SPARC、PowerPC）：
   - 最高有效字节存储在最低地址
   - 需要进行字节序转换

### 性能优化

**优化技巧**：

1. **循环展开**：将循环中的操作展开以减少循环开销
2. **寄存器使用**：尽可能使用寄存器存储中间变量
3. **内联函数**：将f、g、h函数内联以减少函数调用开销
4. **批量处理**：一次处理多个完整的512位块

### 测试向量

RFC 1186提供了标准测试向量：

```
MD4("") = 31d6cfe0d16ae931b73c59d7e0c089c0
MD4("a") = bde52cb31de33e46245e05fbdbd6fb24
MD4("abc") = a448017aaf21d8525fc10ae87aa6729d
MD4("message digest") = d9130a8164549fe818874806e1c7014b
MD4("abcdefghijklmnopqrstuvwxyz") = d79e1c308aa5bbcdeea8ed63df412da9
```

## 历史影响与演进

### MD4的后继者

MD4的设计影响了许多后续的哈希算法：

1. **MD5（RFC 1321）**：
   - 1992年发布，由Rivest设计
   - MD4的直接改进版本
   - 增加了第四轮处理（从3轮增加到4轮）
   - 修改了常量和移位量
   - 使用64个不同的加法常量（MD4只有2个）
   - 调整了辅助函数，增强了安全性
   - 新增I函数用于第四轮：I(X,Y,Z) = Y xor (X v not(Z))
   - 提高了安全性（但后来也被攻破）

2. **SHA-1**：
   - 由NSA设计，基于MD4/MD5的思想
   - 输出160位摘要
   - 增强了安全性

3. **SHA-2系列**：
   - SHA-256、SHA-384、SHA-512
   - 现代推荐使用的哈希算法

### 设计理念的贡献

MD4引入的重要设计理念：

1. **Merkle-Damgård结构**：
   - 将消息分块处理
   - 每块的输出作为下一块的输入
   - 成为后续哈希算法的标准结构

2. **三轮处理**：
   - 使用不同的非线性函数
   - 增加算法的复杂性和安全性
   - 被许多后续算法采用

3. **性能优先**：
   - 专为32位处理器优化
   - 简单的位运算操作
   - 影响了后续算法的设计思路

### 安全性教训

MD4的破解为密码学界提供了重要教训：

1. **三轮不够**：MD4的三轮处理被证明不足以抵抗现代攻击
2. **需要更多混淆**：需要更复杂的非线性函数和更多轮次
3. **持续审查**：密码学算法需要持续的安全性审查和分析

## 现代视角

### 当前状态

**不推荐使用**：
- MD4已被认为在密码学上完全不安全
- 不应用于任何安全关键应用
- 仅具有历史和教育价值

### 推荐的替代方案

**现代应用应使用**：

1. **SHA-256/SHA-512**（SHA-2系列）：
   - 目前广泛使用且安全
   - 适用于大多数应用场景
   - NIST推荐标准

2. **SHA-3**：
   - 2015年标准化
   - 基于不同的设计原理（Keccak）
   - 提供额外的安全边际

3. **BLAKE2/BLAKE3**：
   - 高性能现代哈希算法
   - 比SHA-2更快
   - 适合需要高性能的场景

### 遗留系统

MD4仍可能出现在某些遗留系统中：

1. **NTLM认证**：Windows早期版本使用基于MD4的密码哈希
2. **eDonkey/eMule**：P2P文件共享协议使用MD4
3. **旧版软件**：一些老旧软件可能仍在使用MD4

**迁移建议**：如果系统仍在使用MD4，应尽快迁移到现代安全算法。

## 总结

RFC 1186定义的MD4消息摘要算法是密码学哈希函数发展史上的重要里程碑。作为Ronald Rivest设计的消息摘要算法系列的一员，MD4在1990年代初期提供了出色的性能和相对较好的安全性，成为数字签名和数据完整性验证的重要工具。

**MD4的主要特点**：

1. **128位输出**：为任意长度消息生成固定的128位摘要
2. **高性能**：专为32位处理器优化，处理速度快
3. **简洁实现**：算法简单，不需要大型查找表
4. **三轮处理**：使用三个不同的非线性函数增强安全性

**历史贡献**：

MD4的设计理念深刻影响了后续的密码学哈希算法发展。其Merkle-Damgård结构、分块处理方式和多轮非线性变换成为现代哈希算法的标准设计模式。MD5、SHA-1、SHA-2等广泛使用的算法都借鉴了MD4的设计思想。

**安全性警告**：

尽管MD4在历史上具有重要意义，但现代密码学分析已经证明其存在严重的安全漏洞。1996年Hans Dobbertin发现了实用的碰撞攻击方法，现代计算机可以在极短时间内找到MD4碰撞。因此，MD4不应用于任何安全关键应用，包括数字签名、密码存储、数据完整性验证等场景。

**现代应用建议**：

对于需要密码学哈希函数的现代应用，应使用SHA-256、SHA-512、SHA-3或BLAKE2/BLAKE3等经过充分审查且目前被认为安全的算法。对于密码存储，应使用专门设计的密码哈希函数如bcrypt、scrypt或Argon2。

**教育价值**：

尽管MD4不再适合实际应用，但它仍然具有重要的教育价值。通过研究MD4的设计和已知的攻击方法，密码学学生和研究人员可以更好地理解哈希函数的设计原理、安全性要求以及密码分析技术的发展。

## 参考资料

- RFC 1186: The MD4 Message Digest Algorithm
- RFC 1320: The MD4 Message Digest Algorithm (更新版本)
- RFC 1321: The MD5 Message Digest Algorithm (MD4的改进版本)
- RFC 2104: HMAC: Keyed-Hashing for Message Authentication
- Dobbertin, H. (1996): "Cryptanalysis of MD4"
- NIST FIPS 180-4: Secure Hash Standard (SHS)
- Knuth, D.E.: The Art of Computer Programming, Volume 2 (Seminumerical Algorithms)

## 相关链接

- [RFC 1321](RFC1321.md) - MD5消息摘要算法（MD4的改进版本）
- [RFC 2104](RFC2104.md) - HMAC：基于哈希的消息认证码
